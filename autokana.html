<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="/assets/js/jquery.autoKana.js"></script>
<script src="https://ajaxzip3.github.io/ajaxzip3.js" charset="UTF-8"></script>
<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>

<form id="qr-code-entry" class="form-mimic">
<div>
	<label for="NAME1">名前:</label>
	<input type="text" id="name" value="" placeholder="">
</div>
<div>
	<label for="NAME2">名前ふりがな:</label>
	<input type="text" id="kana" value="" placeholder="">
</div>
<div>
	<label for="TEL1">電話番号:</label>
	<input type="text" id="tel" value="" placeholder="">
</div>
<div class="h-adr">
  <span class="p-country-name" style="display:none;">Japan</span>
	住所:
  <!--〒<input type="text" class="p-postal-code" maxlength="8"><br-->
  〒<input type="text" id="zipcode" name="zipcode" class="p-postal-code" maxlength="8" onKeyUp="AjaxZip3.zip2addr(this,'','pref','city','street');">（自動入力用）<br>
  <input type="text" id="pref" name="pref" class="p-region" placeholder="（都道府県）" />
  <input type="text" id="city" name="city" class="p-locality" placeholder="（市区町村）" /><br>
  <input type="text" id="street" name="street" class="p-street-address" placeholder="（番地）" /><br>
  <input type="text" id="extend-add" class="p-extended-address" placeholder="（建物名など）" />
</div>
<div>
	<label for="MAIL1">E-mail:</label>
	<input type="text" id="mail" value="" placeholder="">
</div>
<div>
	<label for="note">その他:</label>
	<textarea type="textarea" id="note" value="" placeholder="メモ、URLなど"></textarea>
</div>
<div>
	<label for="qrsize">QRコードサイズ:</label>
	<input type="text" id="qrsize" value="200">px
</div>
<div id="g-recaptcha"></div>
<div>
	<input id="create_qr_entry" type="button" value="QRコード生成" class="generate btn btn--primary">
    <input type="reset" value="クリア" class="btn">
</div>
<div id="qr_add">
</div>
</form>

<script type="text/javascript">
$(document).ready( function() {
    $.fn.autoKana('#name', '#kana', {});
});

$(function () {
    $('#create_qr_entry').click(function () {
        var response = grecaptcha.getResponse();
        if (!!response) {
            var data = new Array();
            data['name'] = $("#name").val();
            data['kana'] = $("#kana").val();
            data['tel'] = $("#tel").val();
            data['mail'] = $("#mail").val();
            data['add'] = $("#pref").val() + $("#city").val() + $("#street").val() + $("#extend-add").val();
            data['note'] = $("#note").val();
            data['qrsize'] = $("#qrsize").val();

            if (data['name'] == "") {
                $("#qr_add").html('<span>名前は必ず入力してください。</span>');
            } else if (data['tel'] + data['mail'] + data['add'] + data['note'] == "") {
                $("#qr_add").html('<span>項目は必ず1つ以上入力してください。</span>');
            } else {
                $("#qr_add").html('<img src="' + make_url(make_address_qr(data)) + '">');
            }
        } else {
            $('#qr_add').html('<span>認証をやり直してください。</span>');
            $('.recaptcha').prop('disabled', true);
            grecaptcha.reset();
        }
    });
});
function make_address_qr(data) {
	var result = "";
	result += "MECARD:N:" + data['name'] + ";";
	result += "SOUND:" + data['kana'] + ";";
	result += "TEL:" + data['tel'] + ";";
	result += "ADR:" + data['add'] + ";";
	result += "EMAIL:" + data['mail'] + ";";
	result += "NOTE:" + data['note'] + ";;\r\n";
	result += "MEMORY:" + data['note'] + "\r\n";
	result += "NAME1:" + data['name'] + "\r\n";
	result += "NAME2:" + data['kana'] + "\r\n";
	result += "TEL1:" + data['tel'] + "\r\n";
	result += "ADD:" + data['add'] + "\r\n";
	result += "MAIL1:" + data['mail'] + "\r\n";
	return result;
}

function make_url(data_string) {
    var data_encoded = encodeURI(data_string);
    var url = "https://api.qrserver.com/v1/create-qr-code/?size=" + $("#qrsize").val() + "x" + $("#qrsize").val() + "&qzone=3&format=" + $("#qrformat").val() + "&data=";
    url += data_encoded;
    return url;
}

$(function() {
	$("#create_qr_text").click(make_qr_text);
});
function make_qr_text() {
	var data = new Array();
	data['note'] = $("#note").val();
	data['qrsize'] = $("#qrsize").val();

	$("#qr_text").html('<img src="' + make_url(data['note']) + '">');
}

var onloadCallback = function () {
    grecaptcha.render('g-recaptcha', {
        'callback': function (response) {
            $('.recaptcha').prop('disabled', false);
        },
        'expired-callback': function (response) {
            $('.recaptcha').prop('disabled', true);
        },
        'sitekey': '6LeZoncUAAAAAM1VQsbprrg6tTuj3-1Zsv2pX4ls'
    });
};

</script>
